---
import NoStories from "@components/story/NoStories.astro";
import CreateStory from "@components/story/create/CreateStory";
import StorySummaryGrid from "@components/story/summary/grid/StorySummaryGrid.astro";
import { isNonEmptyArray } from "@util/nonEmptyArray";

import Layout from "../../../layouts/AuthoringLayout.astro";

const user = Astro.locals.user;
if (!user?.id) {
  return Astro.redirect("/login");
}

const { repositoryStory, i18n } = Astro.locals.environment<
  App.WithStoryRepository & App.WithI18N
>();

let stories = await repositoryStory.getStorySummariesByAuthor(user.id);

if (!stories) {
  stories = {
    author: {
      id: user.id,
      name: user.name,
    },
    stories: [],
  };
}

const translations = i18n.getTranslationsForPage({
  locale: Astro.preferredLocale,
  page: "stories",
});

const thereIsAtLeastOneStory = isNonEmptyArray(stories.stories);
---

<Layout
  title={i18n.t("page.stories.meta.title")}
  description={i18n.t("page.stories.meta.description")}
>
  <main>
    <div class="header">
      <h1>
        {i18n.t("page.stories.heading", { authorName: stories.author.name })}
      </h1>

      {
        thereIsAtLeastOneStory && (
          <CreateStory translations={translations} client:only="react" />
        )
      }
    </div>

    {
      thereIsAtLeastOneStory ? (
        <StorySummaryGrid stories={stories.stories} />
      ) : (
        <NoStories translations={translations} />
      )
    }
  </main>
</Layout>

<style>
  main {
    margin: 1rem auto;
    width: 1000px;
  }

  .header {
    display: grid;
    grid-template-columns: 3fr 1fr;

    h1 {
      color: var(--color-text);
    }
  }
</style>
